version: "3.6"
services:
  bespoke-postgres-test:
    image: postgres:11
    container_name: bespoke-postgres-test
    ports:
      - 6543:5432
    restart: always
    volumes:
      - bespoke_db_data_test:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgrespassword
      EVENT_TRIGGER_URL: http://localhost:7002
    healthcheck:
      test: "pg_isready -U postgres"
      interval: 10s
      timeout: 5s
      retries: 5
  bespoke-graphql-engine-test:
    image: hasura/graphql-engine:v1.3.3.cli-migrations-v2
    container_name: bespoke-graphql-engine-test
    ports:
      - 8081:8080
    depends_on:
      - bespoke-postgres-test
    restart: always
    volumes:
      - ./graphql-server/migrations:/hasura-migrations
      - ./graphql-server/metadata:/hasura-metadata
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:postgrespassword@bespoke-postgres-test:5432/postgres
      HASURA_GRAPHQL_ENABLE_CONSOLE: "false" # set to "false" to disable console
      HASURA_GRAPHQL_LOG_LEVEL: error
      HASURA_GRAPHQL_ADMIN_SECRET: myadminsecretkey
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256", "key": "FAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKE"}'
      ASYNC_SERVER_API_KEY: bespoke-async-server-api-key
      ASYNC_SERVER_BASE_URL: "http://bespoke-api-server-test:7002"
  bespoke-api-server-test:
    build:
      context: ./api-server
      dockerfile: Dockerfile
    container_name: bespoke-api-server-test
    ports:
      - 7002:7002
    depends_on:
      - bespoke-postgres-test
    restart: always
    volumes:
      - ./api-server/src:/app/src/
    environment:
      DATABASE_URL: postgres://postgres:postgrespassword@bespoke-postgres-test:5432/postgres
  bespoke-app-test:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: bespoke-app-test
    ports:
      - 3006:3006
    depends_on:
      - bespoke-postgres-test
      - bespoke-graphql-engine-test
      - bespoke-api-server-test
    environment:
      - HOST=bespoke-app-test
      - REACT_APP_BESPOKE_API_ENDPOINT=http://bespoke-api-server-test:7002
      - REACT_APP_BESPOKE_GRAPHQL_ENDPOINT=http://bespoke-graphql-engine-test:8080/v1/graphql
      - REACT_APP_BESPOKE_WS_GRAPHQL_ENDPOINT=ws://bespoke-graphql-engine-test:8080/v1/graphql
    volumes:
      - ./app:/app
      - /app/node_modules
  bespoke-cypress-test:
    image: cypress
    build:
      context: ./app
      dockerfile: Dockerfile-cypress
    container_name: bespoke-cypress-test
    depends_on:
      - bespoke-postgres-test
      - bespoke-graphql-engine-test
      - bespoke-api-server-test
      - bespoke-app-test
    environment:
      - CYPRESS_baseUrl=http://bespoke-app-test:3006
      - CYPRESS_apiServerUrl=http://bespoke-api-server-test:7002
      - CYPRESS_isDocker=true
    command: ./wait-for-it.sh bespoke-app-test:3006 -t 300 -- npx cypress run
    volumes:
      - ./app/cypress:/app/cypress
      - ./app/cypress.json:/app/cypress.json

volumes:
  bespoke_db_data_test:
