subscription GetOpenLoansByDebtFacilityStatuses($statuses: [String!]) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetOpenLoansByDebtFacilityId(
  $statuses: [String!]
  $target_facility_ids: [uuid!]
) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
        { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetReportLoansByDebtFacilityId(
  $debt_facility_statuses: [String!]
  $other_statuses: [String!]
  $target_facility_ids: [uuid!]
) {
  loans(
    where: {
      _and: [
        {
          # Reports pull historicals (i.e. closed loans), so we do not filter for that here
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        {
          _or: [
            {
              _and: [
                { loan_report: { debt_facility_status: { _in: $debt_facility_statuses } } }
                { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
              ]
            }
            { loan_report: { debt_facility_status: { _in: $other_statuses } } }
          ]
        }
        
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetDebtFacilityCapacities {
  debt_facility_capacities(order_by: [{ changed_at: desc }]) {
    id
    ...DebtFacilityCapacityLimited
    debt_facility {
      id
      ...DebtFacilityLimited
    }
  }
}

subscription GetDebtFacilities {
  debt_facilities(order_by: [{ name: desc }]) {
    id
    ...DebtFacilityLimited
    debt_facility_capacities {
      id
      ...DebtFacilityCapacityLimited
    }
  }
}

subscription GetDebtFacilityCurrentCapacities {
  debt_facilities {
    id
    ...DebtFacilityLimited
    debt_facility_capacities(order_by: [{ changed_at: desc }], limit: 1) {
      id
      ...DebtFacilityCapacityLimited
    }
  }
}

subscription GetDebtFacilityCurrentCapacity($target_facility_id: uuid!) {
  debt_facilities(
    where: { id: { _eq: $target_facility_id }}
  ) {
    id
    ...DebtFacilityLimited
    debt_facility_capacities(order_by: [{ changed_at: desc }], limit: 1) {
      id
      ...DebtFacilityCapacityLimited
    }
  }
}
