subscription GetOpenLoansByDebtFacilityStatuses($statuses: [String!]) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        # This was the date requested by the finance team w.r.t. CoVenture
        {
          _or: [
            {
              _and: [
                { loan_type: { _neq: line_of_credit } }
                { origination_date: { _gt: "2021-11-24" } }
              ]
            }
            {
              _and: [
                { loan_type: { _neq: line_of_credit }}
                { origination_date: { _lt: "2021-11-24" }}
                { company: { debt_facility_status: { _eq: "waiver_company" }}}
              ]
            }
            { loan_type: { _eq: line_of_credit }}
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetOpenLoansByDebtFacilityId(
  $statuses: [String!]
  $target_facility_ids: [uuid!]
) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        # This was the date requested by the finance team w.r.t. CoVenture
        {
          _or: [
            {
              _and: [
                { loan_type: { _neq: line_of_credit } }
                { origination_date: { _gt: "2021-11-24" } }
              ]
            }
            {
              _and: [
                { loan_type: { _neq: line_of_credit }}
                { origination_date: { _lt: "2021-11-24" }}
                { company: { debt_facility_status: { _eq: "waiver_company" }}}
              ]
            }
            { loan_type: { _eq: line_of_credit }}
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
        { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetReportLoansByDebtFacilityId(
  $debt_facility_statuses: [String!]
  $other_statuses: [String!]
  $target_facility_ids: [uuid!]
) {
  loans(
    where: {
      _and: [
        {
          # Reports pull historicals (i.e. closed loans), so we do not filter for that here
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        # This was the date requested by the finance team w.r.t. CoVenture
        {
          _or: [
            {
              _and: [
                { loan_type: { _neq: line_of_credit } }
                { origination_date: { _gt: "2021-11-24" } }
              ]
            }
            {
              _and: [
                { loan_type: { _neq: line_of_credit }}
                { origination_date: { _lt: "2021-11-24" }}
                { company: { debt_facility_status: { _eq: "waiver_company" }}}
              ]
            }
            { loan_type: { _eq: line_of_credit }}
          ]
        }
        {
          _or: [
            {
              _and: [
                { loan_report: { debt_facility_status: { _in: $debt_facility_statuses } } }
                { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
              ]
            }
            { loan_report: { debt_facility_status: { _in: $other_statuses } } }
          ]
        }
        
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetDebtFacilities {
  debt_facilities(order_by: [{ name: desc }]) {
    id
    ...DebtFacility
  }
}

subscription GetDebtFacilityCurrentCapacity($target_facility_id: uuid!) {
  debt_facilities(
    where: { id: { _eq: $target_facility_id }}
  ) {
    id
    ...DebtFacility
  }
}

query GetDebtFacilityEventsByLoanReportId($loan_report_id: uuid!) {
  debt_facility_events(
    where: { loan_report_id: { _eq: $loan_report_id }}
    order_by: { event_date: desc }
  ) {
    ...DebtFacilityEvent
  }
}

