subscription GetOpenLoansByDebtFacilityStatuses(
  $statuses: [String!]
) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
        {
          _or: [
            { company: { settings: { is_dummy_account: { _is_null: true } } } }
            { company: { settings: { is_dummy_account: { _eq: false } } } }
          ]
        }
        { origination_date: { _is_null: false } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetOpenLoansByDebtFacilityId(
  $statuses: [String!]
  $target_facility_ids: [uuid!]
) {
  loans(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { closed_at: { _is_null: true } }
        { loan_report: { debt_facility_status: { _in: $statuses } } }
        { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
        {
          _or: [
            { company: { settings: { is_dummy_account: { _is_null: true } } } }
            { company: { settings: { is_dummy_account: { _eq: false } } } }
          ]
        }
        { origination_date: { _is_null: false } }
      ]
    }
  ) {
    id
    ...OpenLoanForDebtFacility
  }
}

subscription GetReportLoansByDebtFacilityId(
  $debt_facility_statuses: [String!]
  $other_statuses: [String!]
  $target_facility_ids: [uuid!]
  $target_date: date!
) {
  
  companies (
    where: { 
      _and: [
        { is_customer: { _eq: true } }
        {
          _or: [
            { settings: { is_dummy_account: { _is_null: true } } }
            { settings: { is_dummy_account: { _eq: false } } }
          ]
        }
      ]
    }
  ) {
    id
    financial_summaries (
      where: {
        date: { _eq: $target_date }
      }
    ) {
      id
      loans_info
    }
    loans(
      where: {
        _and: [
          {
            
            _or: [
              { is_deleted: { _is_null: true } }
              { is_deleted: { _eq: false } }
            ]
          }
          {
            _or: [
              # This captures the 11/24 CoVenture requirement, but since we're dealing
              # with stamps we need to set it to midnight of the next day
              { closed_at: { _gt: "2021-11-25T00:00:00+00:00" } }
              { closed_at: { _is_null: true } }
            ]
          }
          {
            _or: [
              {
                _and: [
                  { loan_report: { debt_facility_status: { _in: $debt_facility_statuses } } }
                  { loan_report: { debt_facility_id: { _in: $target_facility_ids } } }
                ]
              }
              { loan_report: { debt_facility_status: { _in: $other_statuses } } }
            ]
          }
          {
            _or: [
              { company: { settings: { is_dummy_account: { _is_null: true } } } }
              { company: { settings: { is_dummy_account: { _eq: false } } } }
            ]
          }
          {
            _and: [
              { origination_date: { _is_null: false } }
              { origination_date: { _lte: $target_date   } }
            ]
          }
        ]
      }
    ) {
      id
      ...OpenLoanForDebtFacility
    }
  }
}

subscription GetDebtFacilities {
  debt_facilities(order_by: [{ name: desc }]) {
    id
    ...DebtFacility
  }
}

subscription GetDebtFacilityCurrentCapacity($target_facility_id: uuid!) {
  debt_facilities(
    where: { id: { _eq: $target_facility_id }}
  ) {
    id
    ...DebtFacility
  }
}

query GetDebtFacilityEventsByLoanReportId($loan_report_id: uuid!) {
  debt_facility_events(
    where: { loan_report_id: { _eq: $loan_report_id }}
    order_by: { event_date: desc }
  ) {
    ...DebtFacilityEvent
  }
}

