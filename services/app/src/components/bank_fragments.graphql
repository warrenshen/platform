#
# This file is for fragments used by users on the Bank side
#   - Generally speaking, the bank can query nearly all fields

## Users

fragment Contact on users {
  id
  company_id
  full_name
  first_name
  last_name
  email
  phone_number
  created_at
}

fragment AllCompanyUsersForBank on companies {
  parent_company {
    id
    users {
      ...Contact
    }
  }
  users {
    ...Contact
  }
}

fragment CompanyPayorContact on company_payor_contacts {
  id
  payor_user_id
  user {
    id
    ...Contact
  }
}

fragment CompanyVendorContact on company_vendor_contacts {
  id
  vendor_user_id
  user {
    id
    ...Contact
  }
}

## Companies

fragment CustomerForBank on companies {
  id
  identifier
  name
  contract_name
  employer_identification_number
  dba_name
  address
  country
  state
  city
  zip_code
  phone_number
  debt_facility_status
}

fragment CompanySettings on company_settings {
  id
  advances_bespoke_bank_account_id
  collections_bespoke_bank_account_id
  two_factor_message_method
  is_dummy_account
  ...CompanySettingsLimited
}

# Bank accounts can be stored for the Bespoke bank and for customers
fragment BankAccount on bank_accounts {
  id
  torrey_pines_template_name
  wire_template_name
  ...BankAccountLimited
}

fragment CompanyForDebtFacility on companies {
  id
  identifier
  name
  contract_name
  employer_identification_number
  dba_name
  address
  country
  state
  city
  zip_code
  phone_number
  debt_facility_status
  licenses (
    where: {
      _or: [
        { is_deleted: { _is_null: true } }
        { is_deleted: { _eq: false } }
      ]
    }
    order_by: { created_at: desc }
  ) {
    id
    ...CompanyLicense
  }
  contract {
    id
    ...Contract
  }
}

fragment MetrcApiKey on metrc_api_keys {
  id
  created_at
  last_used_at
  is_functioning
  status_codes_payload
  us_state
  use_saved_licenses_only
}

## Purchase Order Financing

fragment Vendor on vendors {
  id
  address
  country
  state
  city
  zip_code
  phone_number
  is_cannabis
  ...VendorLimited
}

fragment PurchaseOrder on purchase_orders {
  id
  bank_note
  ...PurchaseOrderLimited
}

fragment PurchaseOrderForDebtFacility on purchase_orders {
  id
  bank_note
  ...PurchaseOrderLimited
  purchase_order_metrc_transfers {
    id
    metrc_transfer {
      id
      created_date
    }
  }
}

fragment Loan on loans {
  id
  loan_report_id
  notes
  ...LoanLimited
}

fragment LoanForDebtFacility on loans {
  id
  loan_report_id
  notes
  company_id
  loan_type
  artifact_id
  identifier
  disbursement_identifier
  status
  rejection_note
  payment_status
  amount
  requested_payment_date
  origination_date
  maturity_date
  adjusted_maturity_date
  outstanding_principal_balance
  outstanding_interest
  outstanding_fees
  requested_at
  approved_at
  rejected_at
  funded_at
  closed_at
  company {
    id
    identifier
    ...CompanyForDebtFacility
  }
}

fragment LoanReport on loan_reports {
  id
  repayment_date
  total_principal_paid
  total_interest_paid
  total_fees_paid
  financing_period
  financing_day_limit
  debt_facility_status
  debt_facility_id
  debt_facility_added_date
}

fragment LoanArtifact on loans {
  id
  invoice {
    id
    ...Invoice
  }
  line_of_credit {
    id
    ...LineOfCredit
  }
  purchase_order {
    id
    ...PurchaseOrder
  }
  ...LoanArtifactLimited
}

## Invoices
fragment Payor on payors {
  id
  address
  country
  state
  city
  zip_code
  phone_number
  ...PayorLimited
}

fragment PartnershipRequest on company_partnership_requests {
  id
  requesting_company_id
  two_factor_message_method
  company_type
  company_name
  license_info
  is_cannabis
  user_info
  created_at
  requested_by_user_id
  settled_by_user_id
  settled_at
}

fragment VendorPartnership on company_vendor_partnerships {
  id
  vendor_bank_id
  vendor_bank_account {
    id
    verified_at
  }
  ...VendorPartnershipLimited
}

fragment PayorPartnership on company_payor_partnerships {
  id
  ...PayorPartnershipLimited
}

## Finance

fragment Payment on payments {
  id
  bank_note
  created_at
  ...PaymentLimited
}

fragment Transaction on transactions {
  id
  created_at
  loan_id
  payment_id
  type
  subtype
  amount
  effective_date
  to_principal
  to_interest
  to_fees
}

fragment BankFinancialSummary on bank_financial_summaries {
  id
  updated_at
  date
  product_type
  adjusted_total_limit
  total_outstanding_principal
  total_outstanding_interest
  total_outstanding_fees
  total_principal_in_requested_state
  available_limit
  interest_accrued_today
}

fragment AsyncPipelineLimited on async_pipelines {
  id
  created_at
  updated_at
  name
  status
}

fragment AsyncPipeline on async_pipelines {
  id
  ...AsyncPipelineLimited
  internal_state
  params
}

fragment MetrcDownloadSummaryLimited on metrc_download_summaries {
  id
  company_id
  metrc_api_key_id
  license_number
  date
  status
  harvests_status
  packages_status
  plant_batches_status
  plants_status
  sales_status
  transfers_status
  updated_at
}

fragment MetrcDownloadSummary on metrc_download_summaries {
  id
  ...MetrcDownloadSummaryLimited
  num_retries
  err_details
}

fragment DebtFacility on debt_facilities {
  id
  name
  product_types
  maximum_capacities: debt_facility_capacities (
    order_by: [{ changed_at: desc }],
    where: {
      capacity_type: { _eq: "maximum" }
    }
  ) {
    id
    ...DebtFacilityCapacityLimited
  }
  drawn_capacities: debt_facility_capacities (
    order_by: [{ changed_at: desc }],
    where: {
      capacity_type: { _eq: "drawn" }
    }
  ) {
    id
    ...DebtFacilityCapacityLimited
  }
}

fragment DebtFacilityCapacityLimited on debt_facility_capacities {
  id
  amount
  capacity_type
  changed_at
  changed_by
  debt_facility_id
}

fragment OpenLoanForDebtFacility on loans {
  ...LoanForDebtFacility
  loan_report {
    id
    ...LoanReport
    debt_facility {
      id
      ...DebtFacility
    }
  }
  purchase_order {
    id
    ...PurchaseOrderForDebtFacility
  }
  invoice {
    id
    ...Invoice
  }
  transactions ( where: {
    _and: [
      { type: { _eq: "advance"} },
      # This was the date requested by the finance team w.r.t. CoVenture
      { effective_date: { _gt: "2021-11-24" }}
    ]
  }) {
    id
  }
}

fragment DebtFacilityEvent on debt_facility_events {
  id
  company_id
  loan_report_id
  event_amount
  event_category
  event_comments
  event_date
  event_payload
}
