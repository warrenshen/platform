query GetCompanyForCustomerOverview(
  $companyId: uuid!
  $loanType: loan_type_enum
) {
  companies_by_pk(id: $companyId) {
    id
    financial_summary {
      id
      ...FinancialSummary
    }
    outstanding_loans: loans(
      where: {
        _and: [
          { status: { _in: [funded, past_due] } }
          { loan_type: { _eq: $loanType } }
        ]
      }
    ) {
      ...LoanLimited
      line_of_credit {
        id
        ...LineOfCredit
      }
      purchase_order {
        id
        order_number
      }
    }
  }
}

query GetCompanyForCustomerLoans(
  $companyId: uuid!
  $loanStatuses: [loan_status_enum!]
  $loanType: loan_type_enum!
) {
  companies_by_pk(id: $companyId) {
    id
    financial_summary {
      id
      ...FinancialSummary
    }
    loans(
      where: {
        _and: [
          { status: { _in: $loanStatuses } }
          { loan_type: { _eq: $loanType } }
        ]
      }
    ) {
      id
      ...LoanLimited
      line_of_credit {
        id
        ...LineOfCredit
      }
      purchase_order {
        id
        order_number
      }
    }
  }
}

query GetCompanyWithActiveContract($companyId: uuid!) {
  companies_by_pk(id: $companyId) {
    id
    contract {
      id
      ...Contract
    }
  }
}

query GetCompanyForCustomerBorrowingBase($companyId: uuid!) {
  companies_by_pk(id: $companyId) {
    id
    ebba_applications(
      order_by: [{ application_month: desc }, { created_at: desc }]
    ) {
      id
      ...EbbaApplication
      company {
        id
        name
      }
    }
    financial_summary {
      id
      ...FinancialSummary
    }
    settings {
      id
      active_ebba_application {
        id
        ...EbbaApplication
      }
    }
  }
}

query GetCompanyForCustomerContractPage($companyId: uuid!) {
  companies_by_pk(id: $companyId) {
    id
    contract {
      id
      ...Contract
    }
    contracts(order_by: [{ end_date: desc }]) {
      id
      ...Contract
    }
    financial_summary {
      id
      ...FinancialSummary
    }
  }
}

query GetLatestBankFinancialSummaries {
  bank_financial_summaries(limit: 4, order_by: { date: desc }) {
    id
    date
    product_type
    total_limit
    adjusted_total_limit
    total_outstanding_principal
    total_outstanding_interest
    total_outstanding_fees
    total_principal_in_requested_state
    available_limit
  }
}

# Query is used to determine what navigation options to show in sidebar.
query CompanyWithDetailsByCompanyId($companyId: uuid!) {
  companies_by_pk(id: $companyId) {
    id
    contract {
      id
      ...Contract
    }
  }
}

mutation GetCompanyNextLoanIdentifier(
  $companyId: uuid!
  $increment: companies_inc_input!
) {
  update_companies_by_pk(pk_columns: { id: $companyId }, _inc: $increment) {
    id
    latest_loan_identifier
  }
}
