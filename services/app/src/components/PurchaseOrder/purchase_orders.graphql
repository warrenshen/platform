# Bank users
subscription GetPurchaseOrders {
  purchase_orders(
    where: {
      _or: [{ is_deleted: { _is_null: true } }, { is_deleted: { _eq: false } }]
    }
    order_by: [{ updated_at: desc }]
  ) {
    id
    ...PurchaseOrder
  }
}

subscription GetNotConfirmedPurchaseOrders {
  purchase_orders(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { approved_at: { _is_null: true } }
      ]
    }
    order_by: [{ requested_at: desc }, { created_at: desc }]
  ) {
    id
    ...PurchaseOrder
  }
}

subscription GetConfirmedPurchaseOrders {
  purchase_orders(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { approved_at: { _is_null: false } }
      ]
    }
    order_by: [{ approved_at: desc }, { created_at: desc }]
  ) {
    id
    ...PurchaseOrder
  }
}

mutation UpdatePurchaseOrder(
  $id: uuid!
  $purchaseOrder: purchase_orders_set_input!
) {
  update_purchase_orders_by_pk(
    pk_columns: { id: $id }
    _set: $purchaseOrder
  ) {
    id
    ...PurchaseOrder
  }
}

# Customer users
query GetOpenPurchaseOrdersByCompanyId($company_id: uuid!) {
  companies_by_pk(id: $company_id) {
    id
    settings {
      id
      has_autofinancing
    }
  }
  purchase_orders(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { company_id: { _eq: $company_id } }
        { funded_at: { _is_null: true } }
      ]
    }
  ) {
    ...PurchaseOrderLimited
  }
}

query GetClosedPurchaseOrdersByCompanyId($company_id: uuid!) {
  purchase_orders(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { company_id: { _eq: $company_id } }
        { funded_at: { _is_null: false } }
      ]
    }
  ) {
    ...PurchaseOrderLimited
  }
}

query GetFundablePurchaseOrdersByCompanyId($company_id: uuid!) {
  purchase_orders(
    where: {
      _and: [
        {
          _or: [
            { is_deleted: { _is_null: true } }
            { is_deleted: { _eq: false } }
          ]
        }
        { company_id: { _eq: $company_id } }
        { approved_at: { _is_null: false } }
        { funded_at: { _is_null: true } }
      ]
    }
  ) {
    ...PurchaseOrderLimited
  }
}
